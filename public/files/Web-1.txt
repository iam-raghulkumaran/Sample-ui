sqllocaldb info
"ConnectionStrings": {
  "DefaultConnection": "Server=(localdb)\\MSSQLLocalDB;Database=KGL_Test;Trusted_Connection=True;TrustServerCertificate=True"
}



CREATE DATABASE KGL_TEST;
GO
USE KGL_TEST;
GO

-- 1. User_Master
CREATE TABLE User_Master
(
    UserId    INT PRIMARY KEY,
    Username  VARCHAR(50) NOT NULL,
    [Password] VARCHAR(50) NOT NULL,
    UserRole  VARCHAR(20) NOT NULL
);

INSERT INTO User_Master (UserId, Username, [Password], UserRole) VALUES
(1, 'admin1', 'xxx', 'admin'),
(2, 'User', 'xxx', 'user'),
(3, 'superadmin1', 'xxx', 'super'),
(4, 'superadmin2', 'xxx', 'super'),
(5, 'admin2', 'xxx', 'admin'),
(9, 'testvendor', 'xxx', 'vendor');

-- 2. Dept_Master
CREATE TABLE Dept_Master
(
    DeptCode INT PRIMARY KEY,
    DeptName VARCHAR(100),
    DeptSN   VARCHAR(50)
);

INSERT INTO Dept_Master (DeptCode, DeptName, DeptSN) VALUES
(10, 'Pagination', 'Pgn'),
(20, 'Content Inspection', 'Login'),
(30, 'Pre-Edit', 'Pre-Edit'),
(40, 'Copy Editing', 'CE');

-- 3. Vendor_Master
CREATE TABLE Vendor_Master
(
    VendorID   INT PRIMARY KEY,
    VendorName VARCHAR(100) NOT NULL
);

INSERT INTO Vendor_Master (VendorID, VendorName) VALUES
(1, 'Oup'),
(2, 'Wiley'),
(3, 'SAGE'),
(4, 'TF'),
(5, 'Pf'),
(6, 'De');

-- 4. ArticleInfo
CREATE TABLE ArticleInfo
(
    AutoArtID   VARCHAR(20) PRIMARY KEY,
    JBM_AutoID  VARCHAR(20),
    IntrnlID    VARCHAR(20),
    ChapterID   VARCHAR(20),
    ActualPages INT,
    DeptCode    INT FOREIGN KEY REFERENCES Dept_Master(DeptCode),
    VendorID    INT NULL FOREIGN KEY REFERENCES Vendor_Master(VendorID)
);

INSERT INTO ArticleInfo (AutoArtID, JBM_AutoID, IntrnlID, ChapterID, ActualPages, DeptCode, VendorID) VALUES
('U0302', 'OP031', '120004', 'dyr226', 13, 10, NULL),
('U0305', 'OP031', '120007', 'dys001', 13, 10, 2),
('U0326', 'OP031', '120028', 'dys077', 10, 20, NULL),
('U0327', 'OP031', '120029', 'dys078', 16, 20, NULL),
('U0923', 'OP098', '120001', 'hhs064', 43, 30, NULL),
('U0924', 'OP098', '120002', 'hhs067', 43, 40, NULL);


USE KGL_TEST;
GO

-- Login
CREATE PROCEDURE sp_ValidateUser
    @Username VARCHAR(50),
    @Password VARCHAR(50)
AS
BEGIN
    SELECT UserId, Username, UserRole
    FROM User_Master
    WHERE Username = @Username AND [Password] = @Password;
END
GO

-- Get all articles + joined master data
CREATE PROCEDURE sp_GetArticles
AS
BEGIN
    SELECT 
        A.AutoArtID,
        A.JBM_AutoID,
        A.IntrnlID,
        A.ChapterID,
        A.ActualPages,
        A.DeptCode,
        D.DeptName,
        A.VendorID,
        V.VendorName
    FROM ArticleInfo A
    LEFT JOIN Dept_Master D ON A.DeptCode = D.DeptCode
    LEFT JOIN Vendor_Master V ON A.VendorID = V.VendorID;
END
GO

-- Get vendors
CREATE PROCEDURE sp_GetVendors
AS
BEGIN
    SELECT VendorID, VendorName FROM Vendor_Master;
END
GO

-- Update a single article
CREATE PROCEDURE sp_UpdateArticle
    @AutoArtID   VARCHAR(20),
    @DeptCode    INT,
    @VendorID    INT,
    @ActualPages INT
AS
BEGIN
    UPDATE ArticleInfo
    SET DeptCode = @DeptCode,
        VendorID = @VendorID,
        ActualPages = @ActualPages
    WHERE AutoArtID = @AutoArtID;
END
GO

-- Update Vendor only (for checkbox assign)
CREATE PROCEDURE sp_UpdateArticleVendor
    @AutoArtID VARCHAR(20),
    @VendorID  INT
AS
BEGIN
    UPDATE ArticleInfo
    SET VendorID = @VendorID
    WHERE AutoArtID = @AutoArtID;
END
GO


step -2 
Open Tools â†’ NuGet Package Manager â†’ Manage NuGet Packages
Microsoft.Data.SqlClient
System.Data.SqlClient
Microsoft.AspNetCore.Authentication.Cookies

step - 3 
 "ConnectionStrings": {
    "DefaultConnection": "Server=.;Database=KGL_TEST;Trusted_Connection=True;TrustServerCertificate=True"
  },

STEP 3 â€“ Create Models (Models Folder)
 Models
UserModel.cs

public class UserModel
{
    public int UserId { get; set; }
    public string Username { get; set; }
    public string Password { get; set; }
    public string UserRole { get; set; }
}

VendorModel.cs
public class VendorModel
{
    public int VendorID { get; set; }
    public string VendorName { get; set; }
}

DeptModel.cs
public class DeptModel
{
    public int DeptCode { get; set; }
    public string DeptName { get; set; }
    public string DeptSN { get; set; }
}

ArticleModel.cs

using System.Text.Json.Serialization;

namespace Web1.Models
{
    public class ArticleModel
    {
        public string AutoArtID { get; set; }

        [JsonPropertyName("jbmAutoID")]
        public string JBM_AutoID { get; set; }

        public string IntrnlID { get; set; }
        public string ChapterID { get; set; }
        public int ActualPages { get; set; }
        public string DeptName { get; set; }
        public string VendorName { get; set; }
    }

}

STEP 4 â€“ Create Data Access Layer (ADO.NET)
Create new folder: DAL

 DAL/DbHelper.cs

 using Microsoft.Data.SqlClient;
using System.Data;

public class DbHelper
{
    private readonly IConfiguration _config;

    public DbHelper(IConfiguration config)
    {
        _config = config;
    }

    private SqlConnection GetConnection()
    {
        return new SqlConnection(_config.GetConnectionString("DefaultConnection"));
    }

    public DataTable ExecuteDataTable(string procName, SqlParameter[] parameters = null)
    {
        using var con = GetConnection();
        using var cmd = new SqlCommand(procName, con);
        cmd.CommandType = CommandType.StoredProcedure;

        if (parameters != null)
            cmd.Parameters.AddRange(parameters);

        var dt = new DataTable();
        using var da = new SqlDataAdapter(cmd);
        da.Fill(dt);
        return dt;
    }

    public int ExecuteNonQuery(string procName, SqlParameter[] parameters)
    {
        using var con = GetConnection();
        using var cmd = new SqlCommand(procName, con);
        cmd.CommandType = CommandType.StoredProcedure;

        if (parameters != null)
            cmd.Parameters.AddRange(parameters);

        con.Open();
        return cmd.ExecuteNonQuery();
    }
}


STEP 5 â€“ Register Services (Program.cs)

ðŸ“„ Program.cs

using Microsoft.AspNetCore.Authentication.Cookies;

var builder = WebApplication.CreateBuilder(args);

// MVC + API
builder.Services.AddControllersWithViews();
builder.Services.AddControllers();

// DbHelper
builder.Services.AddScoped<DbHelper>();

// Forms Authentication (Cookie)
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
.AddCookie(options =>
{
    options.LoginPath = "/Account/Login";
});

var app = builder.Build();

app.UseStaticFiles();
app.UseRouting();

app.UseAuthentication();
app.UseAuthorization();

app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Account}/{action=Login}/{id?}");

app.MapControllers();

app.Run();


STEP 6 â€“ Account Controller (Login)

Controllers

Create AccountController.cs

using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using System.Security.Claims;

public class AccountController : Controller
{
    private readonly DbHelper _db;

    public AccountController(DbHelper db)
    {
        _db = db;
    }

    [HttpGet]
    public IActionResult Login()
    {
        return View();
    }

    [HttpPost]
    public IActionResult Login(string username, string password)
    {
        var dt = _db.ExecuteDataTable("sp_ValidateUser",
            new SqlParameter[] {
                new("@Username", username),
                new("@Password", password)
            });

        if (dt.Rows.Count == 1)
        {
            var claims = new List<Claim>
            {
                new Claim(ClaimTypes.Name, username)
            };

            var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
            var principal = new ClaimsPrincipal(identity);

            HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);

            return RedirectToAction("Index", "Home");
        }

        ViewBag.Error = "Invalid login";
        return View();
    }

    public IActionResult Logout()
    {
        HttpContext.SignOutAsync();
        return RedirectToAction("Login");
    }
}

Views/Account/Login.cshtml
<form method="post">
    <input name="username" placeholder="Username" />
    <input name="password" type="password" placeholder="Password" />
    <button type="submit">Login</button>
    <span style="color:red">@ViewBag.Error</span>
</form>


STEP 7 â€“ Basic Authentication for Web API

Create folder: Filters

Filters/BasicAuthAttribute.cs

using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;
using Microsoft.Data.SqlClient;
using System.Net;
using System.Text;

public class BasicAuthAttribute : Attribute, IAuthorizationFilter
{
    public void OnAuthorization(AuthorizationFilterContext context)
    {
        var db = context.HttpContext.RequestServices.GetService<DbHelper>();

        var header = context.HttpContext.Request.Headers["Authorization"].ToString();
        if (string.IsNullOrEmpty(header) || !header.StartsWith("Basic "))
        {
            context.Result = new UnauthorizedResult();
            return;
        }

        var encoded = header.Replace("Basic ", "");
        var decoded = Encoding.UTF8.GetString(Convert.FromBase64String(encoded));
        var parts = decoded.Split(':');

        var dt = db.ExecuteDataTable("sp_ValidateUser",
            new SqlParameter[] {
                new("@Username", parts[0]),
                new("@Password", parts[1])
            });

        if (dt.Rows.Count == 0)
            context.Result = new UnauthorizedResult();
    }
}


STEP 8 â€“ Web API Controllers

Controllers/ArticleApiController.cs

using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;

[Route("api/article")]
[ApiController]
[BasicAuth]
public class ArticleApiController : ControllerBase
{
    private readonly DbHelper _db;

    public ArticleApiController(DbHelper db)
    {
        _db = db;
    }

    [HttpGet]
    public IActionResult GetArticles()
    {
        var dt = _db.ExecuteDataTable("sp_GetArticles");
        return Ok(dt);
    }

    [HttpPost("assign")]
    public IActionResult AssignVendor(string autoArtId, int vendorId)
    {
        _db.ExecuteNonQuery("sp_UpdateArticleVendor",
            new SqlParameter[] {
                new("@AutoArtID", autoArtId),
                new("@VendorID", vendorId)
            });

        return Ok();
    }
}


STEP 9 â€“ Home Page + jQuery DataTable
Controllers/HomeController.cs

using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

[Authorize]
public class HomeController : Controller
{
    public IActionResult Index()
    {
        return View();
    }
}

Views/Home/Index.cshtml


Web1
â”‚
â”œâ”€â”€ Controllers
â”‚   â”œâ”€â”€ AccountController.cs      âœ… MVC (Login)
â”‚   â”œâ”€â”€ ArticleApiController.cs   âœ… Web API
â”‚   â””â”€â”€ HomeController.cs         âœ… MVC
â”‚
â”œâ”€â”€ DAL
â”‚   â””â”€â”€ DbHelper.cs               âœ… DB access (Stored Procedures)
â”‚
â”œâ”€â”€ Filters
â”‚   â””â”€â”€ BasicAuthAttribute.cs     âœ… API Authentication
â”‚
â”œâ”€â”€ Models
â”‚   â”œâ”€â”€ ArticleModel.cs
â”‚   â”œâ”€â”€ DeptModel.cs
â”‚   â”œâ”€â”€ UserModel.cs
â”‚   â”œâ”€â”€ VendorModel.cs
â”‚   â””â”€â”€ ErrorViewModel.cs
â”‚
â”œâ”€â”€ Views
â”‚   â”œâ”€â”€ Account
â”‚   â”‚   â””â”€â”€ Login.cshtml          âœ…
â”‚   â”œâ”€â”€ Home
â”‚   â”‚   â”œâ”€â”€ Index.cshtml          âœ… (DataTable page)
â”‚   â”‚   â””â”€â”€ Privacy.cshtml        âœ… (optional)
â”‚   â”œâ”€â”€ Shared
â”‚   â”‚   â”œâ”€â”€ _Layout.cshtml
â”‚   â”‚   â”œâ”€â”€ _ValidationScriptsPartial.cshtml
â”‚   â”‚   â””â”€â”€ Error.cshtml
â”‚   â”œâ”€â”€ _ViewImports.cshtml
â”‚   â””â”€â”€ _ViewStart.cshtml
â”‚
â”œâ”€â”€ appsettings.json              âœ… Connection string
â””â”€â”€ Program.cs                    âœ… Auth, routing, DI



PROJECT OVERVIEW
----------------
This project is an ASP.NET Core MVC application where the UI is built using MVC,
data operations are handled through a Web API, and SQL Server stored procedures
are used for all database interactions. The application allows authenticated
users to view article information and assign vendors using a jQuery DataTable.

TECHNOLOGIES USED
-----------------
- ASP.NET Core MVC for the user interface
- ASP.NET Core Web API for data access
- SQL Server for database
- jQuery and jQuery DataTable for displaying and managing tabular data
- Bootstrap for UI styling
- ADO.NET for database access

NUGET PACKAGES INSTALLED
-----------------------
- Microsoft.Data.SqlClient
  Used to connect ASP.NET Core with SQL Server and execute stored procedures.

- System.Data.SqlClient
  Provides ADO.NET support for DataTable, SqlCommand, and SqlParameter.

- Microsoft.AspNetCore.Authentication.Cookies
  Used to implement Forms Authentication for MVC login.

DATABASE DESIGN
---------------
The database contains both master and transaction tables:

- User_Master
  Stores application users and their roles (admin, user, super, vendor).

- Dept_Master
  Stores department information.

- Vendor_Master
  Stores vendor details.

- ArticleInfo
  The main working table that links departments and vendors to articles.

All database operations are performed using stored procedures only.
No inline SQL queries are used.

AUTHENTICATION FLOW
-------------------
1. MVC Authentication (Forms Authentication)
   - Users log in through the MVC login page.
   - Credentials are validated using a stored procedure.
   - Upon successful login, an authentication cookie is created.
   - Only authenticated users can access secured MVC pages.

2. Web API Authentication (Basic Authentication)
   - Web API endpoints are protected using Basic Authentication.
   - Each API request includes a username and password in the request header.
   - Credentials are validated against the User_Master table.
   - Unauthorized requests are blocked.

Both MVC and Web API use the same User_Master table but
different authentication mechanisms.

APPLICATION FLOW
----------------
1. User logs into the MVC application.
2. After login, the user is redirected to the Home page.
3. The Home page contains a jQuery DataTable.
4. The DataTable loads article data by calling a secured Web API endpoint.
5. The Web API fetches data using stored procedures and returns it to the UI.
6. Paging, sorting, and searching are handled by the DataTable.

DATA FLOW DIAGRAM
-----------------
UI (MVC Page)
  â†’ jQuery AJAX
    â†’ Web API (Basic Authentication)
      â†’ Stored Procedure
        â†’ SQL Server Database

VENDOR ASSIGNMENT FLOW
---------------------
1. The user selects one or more records using checkboxes.
2. The user chooses a vendor from the dropdown list.
3. An API call is made to assign the vendor.
4. The Web API updates the ArticleInfo table using a stored procedure.
5. The DataTable is refreshed to reflect updated data.

SECURITY & BEST PRACTICES
------------------------
- All SQL operations use stored procedures.
- Parameterized queries prevent SQL injection.
- Authentication is enforced for both MVC and Web API.
- Clear separation of concerns between UI, API, and database layers.

SUMMARY
-------
The application follows a clean layered architecture where MVC handles the UI,
Web API handles data access, stored procedures handle database logic, and proper
authentication ensures security. This design closely follows real-world
enterprise application standards.
